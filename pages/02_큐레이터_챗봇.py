import streamlit as st
import google.generativeai as genai

# --- ìƒë‹¨ ë©”ë‰´ ìˆ¨ê¸°ê¸° ë° ì‚¬ì´ë“œë°” ê¸°ë³¸ í¼ì¹¨ ---
st.set_page_config(
    page_title="íë ˆì´í„° ì±—ë´‡", 
    page_icon="ğŸ—£ï¸", 
    layout="wide",
    initial_sidebar_state="expanded"
)
st.markdown("""
<style>
    [data-testid="stSidebarNav"] {
        display: none;
    }
</style>
""", unsafe_allow_html=True)


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì‚¬ì´ë“œë°”: ë‚´ë¹„ê²Œì´ì…˜ & API í‚¤ ì„¤ì •
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.sidebar.title("ğŸ“š ë©”ë‰´")
st.sidebar.page_link("01_ë°•ë¬¼ê´€_ìœ„ì¹˜_ê²€ìƒ‰.py", label="1. ë°•ë¬¼ê´€ ìœ„ì¹˜ ê²€ìƒ‰", icon="ğŸ›ï¸")
st.sidebar.page_link("pages/02_íë ˆì´í„°_ì±—ë´‡.py", label="2. íë ˆì´í„° ì±—ë´‡", icon="ğŸ—£ï¸")
st.sidebar.page_link("pages/03_ìœ ë¬¼_ë‹ë³´ê¸°.py", label="3. ìœ ë¬¼ ë‹ë³´ê¸°", icon="ğŸ–¼ï¸")
st.sidebar.page_link("pages/04_QnA_for_foreigners.py", label="4. Q&A for Foreigners", icon="â“")
st.sidebar.markdown("---")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# API í‚¤ ë¡œë“œ ë° ëª¨ë¸ ì„¤ì •
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
try:
    API_KEY = st.secrets["GOOGLE_API_KEY"]
    genai.configure(api_key=API_KEY)
    st.sidebar.success("âœ… Google API í‚¤ ë¡œë“œ ì„±ê³µ!")
except (KeyError, FileNotFoundError):
    API_KEY = ""
    st.sidebar.error("âš ï¸ `secrets.toml`ì— Google API í‚¤ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.")

st.sidebar.title("ğŸ§  ëª¨ë¸ ì„¤ì •")
temperature = st.sidebar.slider("ì°½ì˜ì„±(temperature)", 0.0, 1.0, 0.5, 0.1) # ì°½ì˜ì„± ê¸°ë³¸ê°’ì„ 0.5ë¡œ ì•½ê°„ ë‚®ì¶¤
reset_btn = st.sidebar.button("ëŒ€í™” ì´ˆê¸°í™”", use_container_width=True, type="secondary")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# âœ… ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (ì‹ ë¢°ì„± ê°•í™”)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
SYSTEM_INSTRUCTION = """
ë„ˆëŠ” ë°•ë¬¼ê´€ì˜ ì „ë¬¸ íë ˆì´í„° ì±—ë´‡ì´ë‹¤. ë„ˆì˜ ê°€ì¥ ì¤‘ìš”í•œ ì„ë¬´ëŠ” ì‚¬ìš©ìê°€ ë¯¸ìˆ  ì‘í’ˆì´ë‚˜ ìœ ë¬¼ì— ëŒ€í•´ ì§ˆë¬¸í–ˆì„ ë•Œ, 'ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ì •ë³´'ì— ê¸°ë°˜í•˜ì—¬ í’ë¶€í•˜ê³  ê¹Šì´ ìˆëŠ” í•´ì„¤ì„ ì œê³µí•˜ëŠ” ê²ƒì´ë‹¤.

**[ë§¤ìš° ì¤‘ìš”í•œ ì›ì¹™: ë‹µë³€ì˜ ì‹ ë¢°ì„±]**
1.  **ì‚¬ì‹¤ ê¸°ë°˜ ì‘ë‹µ**: ë„ˆì˜ ëª¨ë“  ë‹µë³€ì€ ë°˜ë“œì‹œ ë°•ë¬¼ê´€ ê³µì‹ ìë£Œ, í•™ìˆ  ë…¼ë¬¸, ì €ëª…í•œ ë¯¸ìˆ ì‚¬ ì„œì  ë“± ê²€ì¦ëœ ì¶œì²˜ì— ê¸°ë°˜í•´ì•¼ í•œë‹¤.
2.  **ë¶ˆí™•ì‹¤ì„± ëª…ì‹œ**: ë§Œì•½ í•™ê³„ì—ì„œ ì˜ê²¬ì´ ê°ˆë¦¬ê±°ë‚˜ ëª…í™•í•˜ê²Œ ë°í˜€ì§€ì§€ ì•Šì€ ì‚¬ì‹¤ì— ëŒ€í•´ ì„¤ëª…í•  ë•ŒëŠ”, "ì´ ë¶€ë¶„ì— ëŒ€í•´ì„œëŠ” ì—¬ëŸ¬ í•™ì„¤ì´ ìˆìŠµë‹ˆë‹¤" ë˜ëŠ” "~ë¼ê³  ì¶”ì •ë©ë‹ˆë‹¤" ì™€ ê°™ì´ ë¶ˆí™•ì‹¤í•˜ë‹¤ëŠ” ì ì„ ëª…í™•íˆ ë°í˜€ì•¼ í•œë‹¤.
3.  **ì •ë³´ ë¶€ì¬ ì‹œ ì¸ì •**: ëª¨ë¥´ëŠ” ì •ë³´ë‚˜ í™•ì¸í•  ìˆ˜ ì—†ëŠ” ë‚´ìš©ì— ëŒ€í•´ì„œëŠ” ì ˆëŒ€ ì¶”ì¸¡í•´ì„œ ë‹µë³€í•˜ì§€ ì•ŠëŠ”ë‹¤. ëŒ€ì‹  "ì£„ì†¡í•˜ì§€ë§Œ í•´ë‹¹ ì •ë³´ì— ëŒ€í•œ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ìë£Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ì—ˆìŠµë‹ˆë‹¤"ë¼ê³  ì†”ì§í•˜ê²Œ ë‹µë³€í•´ì•¼ í•œë‹¤.

**[í•´ì„¤ ìŠ¤íƒ€ì¼]**
ìœ„ì˜ ì‹ ë¢°ì„± ì›ì¹™ì„ ì§€í‚¤ëŠ” ì„ ì—ì„œ, ì•„ë˜ ìŠ¤íƒ€ì¼ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì—®ì–´ ì„¤ëª…í•˜ë¼:
-   **ìŠ¤í† ë¦¬í…”ë§**: ì‘í’ˆì— ì–½íŒ í¥ë¯¸ë¡œìš´ ì´ì•¼ê¸°ë‚˜ ì‘ê°€ì˜ ì‚¶ì„ ì‚¬ì‹¤ì— ê¸°ë°˜í•˜ì—¬ í’€ì–´ë‚¸ë‹¤.
-   **ë§¥ë½ ì œê³µ**: ì‘í’ˆì´ ë§Œë“¤ì–´ì§„ ì‹œëŒ€ì  ë°°ê²½, ë¯¸ìˆ  ì‚¬ì¡° ë“±ì„ í•¨ê»˜ ì„¤ëª…í•˜ì—¬ ì´í•´ë¥¼ ë•ëŠ”ë‹¤.
-   **ì „ë¬¸ì  ë¶„ì„**: ì‘í’ˆì— ì‚¬ìš©ëœ ìƒì§•, ê¸°ë²• ë“±ì„ ì „ë¬¸ê°€ì˜ ì‹œê°ìœ¼ë¡œ ë¶„ì„í•œë‹¤.
-   **ëŒ€í™” ìœ ë„**: ì„¤ëª… ë§ˆì§€ë§‰ì—ëŠ” í•­ìƒ ì‚¬ìš©ìê°€ ì¶”ê°€ ì§ˆë¬¸ì„ í•  ìˆ˜ ìˆë„ë¡ ìì—°ìŠ¤ëŸ½ê²Œ ëŒ€í™”ë¥¼ ì´ëˆë‹¤.
"""

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì„¸ì…˜ ìƒíƒœ: ë©€í‹°í„´ ëŒ€í™” ì €ì¥
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if "curator_msgs" not in st.session_state or reset_btn:
    st.session_state.curator_msgs = [
        {"role": "assistant", "content": "ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìœ ë¬¼ê³¼ ì˜ˆìˆ  ì‘í’ˆì„ ì„¤ëª…í•´ ë“œë¦¬ëŠ” íë ˆì´í„° ì±—ë´‡ì…ë‹ˆë‹¤. ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”."}
    ]

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Gemini ëª¨ë¸ ì¤€ë¹„
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
model = None
if API_KEY:
    try:
        model = genai.GenerativeModel(
            "gemini-1.5-flash",
            system_instruction=SYSTEM_INSTRUCTION
        )
    except Exception as e:
        st.error(f"ëª¨ë¸ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜: {e}")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ìœ í‹¸: Streamlit íˆìŠ¤í† ë¦¬ â†’ Gemini history í¬ë§· ë³€í™˜
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def to_gemini_history(streamlit_msgs):
    history = []
    for m in streamlit_msgs:
        role = "user" if m["role"] == "user" else "model"
        history.append({"role": role, "parts": [m["content"]]})
    return history

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# UI
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.title("ğŸ—£ï¸ íë ˆì´í„° ì±—ë´‡")
st.caption("ì „ì‹œ/ìœ ë¬¼ì— ëŒ€í•´ ì§ˆë¬¸í•˜ë©´ íë ˆì´í„°ì²˜ëŸ¼ ê¹Šì´ ìˆê²Œ í•´ì„¤í•´ ë“œë ¤ìš”. (ì˜ˆ: 'ì‹ ë¼ ê¸ˆê´€ì˜ íŠ¹ì§• ì•Œë ¤ì¤˜')")

# ê¸°ì¡´ ëŒ€í™” ë Œë”ë§
for m in st.session_state.curator_msgs:
    with st.chat_message(m["role"]):
        st.markdown(m["content"])

# ì…ë ¥ì°½
if user_text := st.chat_input("ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”â€¦"):
    # 1) ì‚¬ìš©ì ë©”ì‹œì§€ ë°˜ì˜
    st.session_state.curator_msgs.append({"role": "user", "content": user_text})
    with st.chat_message("user"):
        st.markdown(user_text)

    # 2) ëª¨ë¸ ì‘ë‹µ ìƒì„±
    if not model:
        answer = "âš ï¸ API í‚¤ê°€ ì—†ì–´ ì‘ë‹µì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. `secrets.toml` íŒŒì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”."
    else:
        try:
            gemini_history = to_gemini_history(st.session_state.curator_msgs[:-1])
            chat = model.start_chat(history=gemini_history)
            resp = chat.send_message(
                user_text,
                generation_config=genai.types.GenerationConfig(temperature=temperature)
            )
            answer = resp.text.strip()
            if not answer:
                answer = "ì£„ì†¡í•´ìš”, ì§€ê¸ˆì€ ë‹µë³€ì„ ìƒì„±í•˜ì§€ ëª»í–ˆì–´ìš”. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”."
        except Exception as e:
            answer = f"ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”: {e}"

    # 3) ëª¨ë¸ ì‘ë‹µ ë³´ê´€ + ì¶œë ¥
    st.session_state.curator_msgs.append({"role": "assistant", "content": answer})
    with st.chat_message("assistant"):
        st.markdown(answer)

# ì²« í™”ë©´ ë„ì›€ë§
if len(st.session_state.curator_msgs) == 1:
    st.info("ì˜ˆì‹œ) 'ì´ì§‘íŠ¸ ë¯¸ë¼ ì „ì‹œë¥¼ ë³¼ ë•Œ ì–´ë–¤ ì ì„ ì£¼ì˜í•˜ë©´ ì¢‹ì„ê¹Œ?' 'ê³ ë ¤ì²­ìì˜ ëŒ€í‘œ ë¬¸ì–‘ê³¼ ì œì‘ ê¸°ë²•ì€?'", icon="ğŸ’¡")